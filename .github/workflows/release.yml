name: Release birthday-invitation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validation:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install deps
        run: npm ci
      - name: Validation
        run: npm run lint || true

  security:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4
      - name: npm audit
        run: npm audit --audit-level=high || true

  build:
    runs-on: ubuntu-latest
    needs: [validation, security]
    permissions:
      contents: read
      packages: write
    outputs:
      result: ${{ job.status }}
      version: ${{ steps.set_outputs.outputs.version }}
      build_id: ${{ steps.set_outputs.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" \
          | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Set build outputs
        id: set_outputs
        run: |
          VERSION=$(jq -r .version package.json)
          BUILD_ID="${GITHUB_SHA::7}-$(date +%Y%m%d%H%M%S)"
          echo "VERSION=$VERSION"
          echo "BUILD_ID=$BUILD_ID"

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º outputs –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö job
          echo "::set-output name=version::$VERSION"
          echo "::set-output name=build_id::$BUILD_ID"

      - name: Build image
        run: |
          docker build \
            -t ghcr.io/${{ github.repository }}/app:${{ github.sha }} .

      - name: Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/app:${{ github.sha }}

      - name: Push image
        run: |
          docker push ghcr.io/${{ github.repository }}/app:${{ github.sha }}


  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    outputs:
      result: ${{ job.status }}
    steps:
      - name: Deploy (blue/green)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            IMAGE=ghcr.io/${{ github.repository }}/app:${{ github.sha }}

            echo "üîë Logging into GHCR..."
            docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} -p ${{ secrets.GHCR_TOKEN }}
            docker pull $IMAGE

            echo "üì¶ Determining current deployment..."
            CURRENT=$(docker ps --format "{{.Names}}" | grep app_ || true)

            if [ "$CURRENT" = "app_blue" ]; then
              NEW=app_green
              OLD=app_blue
            else
              NEW=app_blue
              OLD=app_green
            fi

            # --- –°–µ—Ç—å backend ---
            echo "üåê Ensuring Docker network 'backend' exists..."
            docker network inspect backend >/dev/null 2>&1 || docker network create backend

            # --- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä NEW, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è ---
            if docker ps -a --format "{{.Names}}" | grep -q "^$NEW$"; then
              echo "‚ö†Ô∏è Removing leftover $NEW container..."
              docker rm -f $NEW
            fi

            echo "üöÄ Starting new container $NEW..."
            docker run -d \
              --name $NEW \
              --network backend \
              -e GIT_COMMIT=${{ github.sha }} \
              $IMAGE

            echo "üîç Waiting for healthcheck..."
            for i in {1..10}; do
              if docker exec $NEW wget -qO- http://localhost:3000/health; then
                echo "‚úÖ Healthcheck passed"
                break
              fi
              sleep 3
            done

            echo "üîÑ Switching nginx upstream..."
            sed -i "s/$OLD/$NEW/g" /opt/birthday/nginx/upstream.conf
            docker exec birthday_nginx nginx -s reload

            echo "üóë Removing old container $OLD..."
            docker rm -f $OLD || true

            echo "‚úÖ Deployment completed: $NEW is live"


  notify:
    runs-on: ubuntu-latest
    needs: [validation, security, build, deploy]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Send deployment notification
        env:
          APP_NAME: birthday-invitation
          BUILD_STATUS: ${{ needs.build.result }}
          DEPLOY_STATUS: ${{ needs.deploy.result }}
          BUILD_VERSION: ${{ needs.build.outputs.version }}
          BUILD_ID: ${{ needs.build.outputs.build_id }}
          DOMAIN: ${{ secrets.DOMAIN }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VALIDATION: ${{ needs.validation.result }}
          SECURITY: ${{ needs.security.result }}
          DEPLOY: ${{ needs.deploy.result }}

        run: |
          echo "üì® Sending deployment notification..."

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –∏–∫–æ–Ω–∫–∏
          if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
            EMOJI="üéâ"
            STATUS_TEXT="<b>–£–°–ü–ï–®–ù–û</b> ‚úÖ"
            STATUS_ICON="üü¢"
          elif [ "$DEPLOY_STATUS" = "failure" ]; then
            EMOJI="‚ùå"
            STATUS_TEXT="<b>–û–®–ò–ë–ö–ê –î–ï–ü–õ–û–Ø</b> üî¥"
            STATUS_ICON="üî¥"
          elif [ "$BUILD_STATUS" = "failure" ]; then
            EMOJI="üö®"
            STATUS_TEXT="<b>–û–®–ò–ë–ö–ê –°–ë–û–†–ö–ò</b> üü†"
            STATUS_ICON="üü†"
          else
            EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="<b>–ù–ï–ò–ó–í–ï–°–¢–ù–û</b> ‚ö™"
            STATUS_ICON="‚ö™"
          fi

          # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ—É –æ –∫–æ–º–º–∏—Ç–µ
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          BRANCH="${GITHUB_REF#refs/heads/}"

          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          cat > message.txt << 'EOF'
          $EMOJI <b>–î–µ–ø–ª–æ–π birthday-invitation</b>
          
          $STATUS_ICON –°—Ç–∞—Ç—É—Å: $STATUS_TEXT
          üì¶ –í–µ—Ä—Å–∏—è: <code>$BUILD_VERSION</code>
          üè∑Ô∏è –°–±–æ—Ä–∫–∞: <code>$BUILD_ID</code>
          
          üìù <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–º–∏—Ç–µ:</b>
          ‚îî‚îÄ –í–µ—Ç–∫–∞: <code>$BRANCH</code>
          ‚îî‚îÄ –ö–æ–º–º–∏—Ç: <code>$COMMIT_SHA</code>
          ‚îî‚îÄ –ê–≤—Ç–æ—Ä: $COMMIT_AUTHOR
          ‚îî‚îÄ –°–æ–æ–±—â–µ–Ω–∏–µ: $COMMIT_MESSAGE
          
          üåê <b>–î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:</b>
          ‚Ä¢ https://${{ secrets.DOMAIN }}
          ‚Ä¢ http://${{ secrets.SERVER_IP }}
          
          üîß <b>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è:</b>
          ‚Ä¢ https://${{ secrets.DOMAIN }}/health
          ‚Ä¢ https://${{ secrets.DOMAIN }}/version
          
          üìä <b>–°—Ç–∞—Ç—É—Å—ã:</b>
          ‚Ä¢ –í–∞–ª–∏–¥–∞—Ü–∏—è: ${{ needs.validation.result }}
          ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: ${{ needs.security.result }}
          ‚Ä¢ –°–±–æ—Ä–∫–∞: ${{ needs.build.result }}
          ‚Ä¢ –î–µ–ø–ª–æ–π: ${{ needs.deploy.result }}
          
          üïê <i>$(date '+%d.%m.%Y %H:%M:%S')</i>
          EOF
          
          # –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
          MESSAGE=$(envsubst < message.txt)
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
          echo "Sending to Telegram..."
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"$(echo "$MESSAGE" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\\n/\\\\n/g')\",
              \"parse_mode\": \"HTML\",
              \"disable_web_page_preview\": true,
              \"reply_markup\": {
                \"inline_keyboard\": [
                  [
                    {\"text\": \"üåê –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\", \"url\": \"https://${{ secrets.DOMAIN }}\"},
                    {\"text\": \"üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏\", \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}
                  ]
                ]
              }
            }"
          
          echo "‚úÖ Notification sent to Telegram"
          rm -f message.txt