name: Deploy

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build & Push"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e

          IMAGE=ghcr.io/${{ github.repository }}/app:${{ github.sha }}

          docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
          docker pull $IMAGE

          CURRENT=$(docker ps --format "{{.Names}}" | grep app_ || true)

          if [ "$CURRENT" = "app_blue" ]; then
            NEW=app_green
            OLD=app_blue
          else
            NEW=app_blue
            OLD=app_green
          fi

          docker run -d \
            --name $NEW \
            --network backend \
            -e GIT_COMMIT=${{ github.sha }} \
            $IMAGE

          for i in {1..10}; do
            docker exec $NEW wget -qO- http://localhost:3000/health && break
            sleep 3
          done

          sed -i "s/$OLD/$NEW/g" /opt/birthday/nginx/upstream.conf
          docker exec birthday_nginx nginx -s reload

          docker rm -f $OLD || true
