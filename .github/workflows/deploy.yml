name: üöÄ Production Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force:
        description: 'Force deployment (skip tests)'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== VALIDATION ====================
  validate:
    name: üîç Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

  # ==================== BUILD ====================
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      build_id: ${{ steps.generate_build_id.outputs.build_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Extract version
      id: extract_version
      run: |
        VERSION=$(node -p "require('./package.json').version || '1.0.0'")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üì¶ Version: $VERSION"
    
    - name: Generate build ID
      id: generate_build_id
      run: |
        BUILD_ID="${GITHUB_SHA:0:7}-$(date +%Y%m%d%H%M%S)"
        echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
        echo "üè∑Ô∏è Build ID: $BUILD_ID"
    
    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        npm ci
    
    - name: Build application
      env:
        VITE_TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        VITE_TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        VITE_APP_VERSION: ${{ steps.extract_version.outputs.version }}
        VITE_BUILD_ID: ${{ steps.generate_build_id.outputs.build_id }}
        VITE_BUILD_DATE: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        VITE_COMMIT_SHA: ${{ github.sha }}
      run: |
        echo "üöÄ Building application..."
        npm run build
        
        if [ ! -f "dist/index.html" ]; then
          echo "‚ùå dist/index.html not found!"
          exit 1
        fi
        
        echo "üìÅ Build contents:"
        ls -la dist/
    
    - name: Create build manifest
      run: |
        echo "üìÑ Creating build manifest..."
        cat > dist/build-manifest.json << EOF
        {
          "application": "birthday-invitation",
          "version": "${{ steps.extract_version.outputs.version }}",
          "buildId": "${{ steps.generate_build_id.outputs.build_id }}",
          "commitSha": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "builtAt": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        }
        EOF
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ steps.generate_build_id.outputs.build_id }}
        path: dist/
        retention-days: 30

  # ==================== DEPLOY ====================
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ needs.build.outputs.build_id }}
        path: .  # –°–∫–∞—á–∏–≤–∞–µ–º –≤ —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    
    - name: List downloaded files
      run: |
        echo "üìÅ Downloaded files:"
        ls -la
        echo "üìÅ dist directory:"
        ls -la dist/ 2>/dev/null || echo "dist directory not found"
    
    - name: Setup SSH
      run: |
        echo "üîê Setting up SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        cat >> ~/.ssh/config << 'EOF'
        Host deploy-server
          HostName ${{ secrets.SERVER_IP }}
          User ${{ secrets.DEPLOY_USER }}
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config
    
    - name: Verify server connectivity
      run: |
        echo "üîç Testing server connection..."
        ssh deploy-server "echo '‚úÖ Connected!' && hostname"
    
    - name: Create backup
      run: |
        echo "üíæ Creating backup..."
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        ssh deploy-server "
          sudo mkdir -p /var/backups/birthday-invitation
          if [ -d '/var/www/birthday-invitation/dist' ]; then
            echo 'Creating backup of existing deployment...'
            sudo tar -czf '/var/backups/birthday-invitation/backup_\$TIMESTAMP.tar.gz' -C '/var/www/birthday-invitation' dist/
            echo '‚úÖ Backup created: backup_\$TIMESTAMP.tar.gz'
            echo 'Backup size:'
            sudo du -h '/var/backups/birthday-invitation/backup_\$TIMESTAMP.tar.gz'
          else
            echo '‚ö†Ô∏è No existing deployment found, skipping backup'
          fi
        "
    
    - name: Prepare directory on server
      run: |
        echo "üìÅ Preparing directory on server..."
        ssh deploy-server "
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          sudo mkdir -p '/var/www/birthday-invitation'
          sudo chown -R '${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }}' '/var/www/birthday-invitation'
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
          if [ -d '/var/www/birthday-invitation/dist' ]; then
            echo 'Cleaning old deployment...'
            rm -rf '/var/www/birthday-invitation/dist/*'
          else
            mkdir -p '/var/www/birthday-invitation/dist'
          fi
          
          echo 'Directory prepared:'
          ls -la '/var/www/birthday-invitation/'
        "
    
    - name: Deploy files to server
      run: |
        echo "üì§ Deploying files to server..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        echo "Checking local files..."
        if [ ! -d "dist" ]; then
          echo "‚ùå dist directory not found locally!"
          ls -la
          exit 1
        fi
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –æ–¥–Ω–æ–º—É –∏–ª–∏ –≤—Å—é –ø–∞–ø–∫—É
        echo "Copying dist directory..."
        scp -r dist deploy-server:'/var/www/birthday-invitation/'
        
        echo "‚úÖ Files copied to server"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å
        ssh deploy-server "
          echo 'Checking deployed files on server...'
          ls -la '/var/www/birthday-invitation/dist/' | head -10
          echo 'Total files count:'
          find '/var/www/birthday-invitation/dist/' -type f | wc -l
        "
    
    - name: Set permissions on server
      run: |
        echo "üîí Setting permissions on server..."
        ssh deploy-server "
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
          sudo chown -R www-data:www-data '/var/www/birthday-invitation/dist'
          sudo find '/var/www/birthday-invitation/dist' -type f -exec chmod 644 {} \;
          sudo find '/var/www/birthday-invitation/dist' -type d -exec chmod 755 {} \;
          
          echo 'Permissions set:'
          ls -la '/var/www/birthday-invitation/dist/' | head -5
        "
    
    - name: Configure Nginx
      run: |
        echo "‚öôÔ∏è Configuring Nginx..."
        
        # –°–æ–∑–¥–∞–µ–º nginx –∫–æ–Ω—Ñ–∏–≥
        cat > nginx-birthday.conf << 'EOF'
        server {
            listen 80;
            server_name DOMAIN www.DOMAIN;
            return 301 https://$server_name$request_uri;
        }
        
        server {
            listen 443 ssl http2;
            listen [::]:443 ssl http2;
            server_name DOMAIN www.DOMAIN;
            
            ssl_certificate /etc/ssl/certs/birthday-invitation.crt;
            ssl_certificate_key /etc/ssl/private/birthday-invitation.key;
            
            root /var/www/birthday-invitation/dist;
            index index.html;
            
            location / {
                try_files $uri $uri/ /index.html;
            }
            
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
            
            # Health check endpoint
            location /health {
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
        }
        EOF
        
        # –ó–∞–º–µ–Ω—è–µ–º DOMAIN –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω
        sed -i "s/DOMAIN/${{ secrets.DOMAIN }}/g" nginx-birthday.conf
        
        # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp nginx-birthday.conf deploy-server:/tmp/nginx-birthday.conf
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh deploy-server "
          echo 'Setting up Nginx configuration...'
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ nginx
          if ! command -v nginx &> /dev/null; then
            echo 'Installing nginx...'
            sudo apt update
            sudo apt install -y nginx
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥
          sudo cp /tmp/nginx-birthday.conf /etc/nginx/sites-available/birthday-invitation
          
          # –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -L '/etc/nginx/sites-enabled/birthday-invitation' ]; then
            sudo ln -s /etc/nginx/sites-available/birthday-invitation /etc/nginx/sites-enabled/
          fi
          
          # –£–¥–∞–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å–∞–π—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
          sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          echo 'Testing Nginx configuration...'
          sudo nginx -t
          
          if [ $? -eq 0 ]; then
            echo '‚úÖ Nginx configuration test passed'
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
            echo 'Reloading Nginx...'
            sudo systemctl reload nginx
            
            echo 'Nginx status:'
            sudo systemctl status nginx --no-pager | head -5
          else
            echo '‚ùå Nginx configuration test failed'
            exit 1
          fi
        "
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        rm nginx-birthday.conf
    
    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        
        # –ñ–¥–µ–º —á—Ç–æ–±—ã nginx —É—Å–ø–µ–ª –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
        sleep 5
        
        echo "Running verification checks..."
        
        ssh deploy-server "
          echo '=== Server Status ==='
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º nginx
          echo '1. Nginx service status:'
          sudo systemctl is-active nginx
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
          echo ''
          echo '2. Deployed files:'
          ls -la '/var/www/birthday-invitation/dist/' | grep -E 'index.html|total'
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
          echo ''
          echo '3. Local accessibility:'
          if command -v curl > /dev/null; then
            echo 'HTTP status from localhost:'
            curl -s -o /dev/null -w '%{http_code}' https://localhost/ && echo ' - OK'
          else
            echo 'curl not available, installing...'
            sudo apt update && sudo apt install -y curl
            curl -s -o /dev/null -w '%{http_code}' https://localhost/ && echo ' - OK'
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
          echo ''
          echo '4. SSL certificate check:'
          if [ -f '/etc/ssl/certs/birthday-invitation.crt' ]; then
            echo '‚úÖ SSL certificate found'
          else
            echo '‚ö†Ô∏è SSL certificate not found at /etc/ssl/certs/birthday-invitation.crt'
          fi
        "
        
        echo ""
        echo "=========================================="
        echo "üéâ DEPLOYMENT COMPLETED!"
        echo ""
        echo "üåê Your application is available at:"
        echo "   ‚Ä¢ https://${{ secrets.DOMAIN }}"
        echo "   ‚Ä¢ http://${{ secrets.SERVER_IP }} (redirects to HTTPS)"
        echo ""
        echo "üìä Health check:"
        echo "   ‚Ä¢ https://${{ secrets.DOMAIN }}/health"
        echo ""
        echo "üîß Build information:"
        echo "   ‚Ä¢ Version: ${{ needs.build.outputs.version }}"
        echo "   ‚Ä¢ Build ID: ${{ needs.build.outputs.build_id }}"
        echo "=========================================="

  # ==================== NOTIFICATION ====================
  notify:
    name: üì® Notify
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: Send Telegram notification
      env:
        BUILD_STATUS: ${{ needs.build.result }}
        DEPLOY_STATUS: ${{ needs.deploy.result }}
      run: |
        echo "üì® Sending Telegram notification..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
          EMOJI="üéâ"
          STATUS="‚úÖ –£–°–ü–ï–®–ù–û"
        elif [ "$DEPLOY_STATUS" = "failure" ]; then
          EMOJI="‚ùå"
          STATUS="‚ö†Ô∏è –û–®–ò–ë–ö–ê –î–ï–ü–õ–û–Ø"
        elif [ "$BUILD_STATUS" = "failure" ]; then
          EMOJI="üö®"
          STATUS="‚ö†Ô∏è –û–®–ò–ë–ö–ê –°–ë–û–†–ö–ò"
        else
          EMOJI="‚ö™"
          STATUS="‚ùì –ù–ï–ò–ó–í–ï–°–¢–ù–û"
        fi
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        MESSAGE="${EMOJI} <b>–î–µ–ø–ª–æ–π birthday-invitation</b>

${STATUS}

üì¶ –í–µ—Ä—Å–∏—è: ${{ needs.build.outputs.version }}
üè∑Ô∏è –°–±–æ—Ä–∫–∞: ${{ needs.build.outputs.build_id }}

üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
https://${{ secrets.DOMAIN }}

üïê $(date '+%d.%m.%Y %H:%M:%S')"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$MESSAGE\",
            \"parse_mode\": \"HTML\"
          }" || echo "‚ö†Ô∏è Failed to send Telegram notification"
        
        echo "‚úÖ Notification sent"

  # ==================== CLEANUP ====================
  cleanup:
    name: üßπ Cleanup
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    
    steps:
    - name: Deployment summary
      run: |
        echo "üìã ===== DEPLOYMENT SUMMARY ====="
        echo ""
        echo "üèóÔ∏è Application: birthday-invitation"
        echo "üöÄ Trigger: ${{ github.event_name }}"
        echo "üë§ Actor: ${{ github.actor }}"
        echo "üåø Branch: ${{ github.ref_name }}"
        echo ""
        echo "üìä Pipeline Results:"
        echo "  ‚úÖ Validate: ${{ needs.validate.result }}"
        echo "  ‚úÖ Build: ${{ needs.build.result }}"
        echo "  ‚úÖ Deploy: ${{ needs.deploy.result }}"
        echo "  ‚úÖ Notify: ${{ needs.notify.result }}"
        echo ""
        echo "üåê Application URL: https://${{ secrets.DOMAIN }}"
        echo "üè∑Ô∏è Build ID: ${{ needs.build.outputs.build_id }}"
        echo "üì¶ Version: ${{ needs.build.outputs.version }}"
        echo ""
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "üéâ Deployment successful! Your application is live!"
        else
          echo "‚ùå Deployment failed. Check logs above for details."
        fi