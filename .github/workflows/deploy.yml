name: üöÄ Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      env:
        VITE_TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        VITE_TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "üöÄ Building application..."
        npm run build
        
        echo "üìÅ Build contents:"
        ls -la dist/
        
        if [ ! -f "dist/index.html" ]; then
          echo "‚ùå dist/index.html not found!"
          exit 1
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 30

  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
    
    - name: Setup SSH
      run: |
        echo "üîê Setting up SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        cat >> ~/.ssh/config << 'EOF'
        Host deploy-server
          HostName ${{ secrets.SERVER_IP }}
          User ${{ secrets.DEPLOY_USER }}
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config
    
    - name: Verify server connectivity
      run: |
        echo "üîç Testing server connection..."
        ssh deploy-server "echo '‚úÖ Connected to server!'"
    
    - name: Create backup
      run: |
        echo "üíæ Creating backup..."
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        ssh deploy-server "
          sudo mkdir -p /var/backups/birthday-invitation
          if [ -d '/var/www/birthday-invitation/dist' ]; then
            echo 'Creating backup...'
            sudo tar -czf \"/var/backups/birthday-invitation/backup_$TIMESTAMP.tar.gz\" -C '/var/www/birthday-invitation' dist/
            echo '‚úÖ Backup created'
          else
            echo '‚ö†Ô∏è No existing deployment'
          fi
        "
    
    - name: Prepare directory
      run: |
        echo "üìÅ Preparing directory..."
        ssh deploy-server "
          sudo mkdir -p '/var/www/birthday-invitation'
          sudo chown -R '${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }}' '/var/www/birthday-invitation'
          
          if [ -d '/var/www/birthday-invitation/dist' ]; then
            rm -rf '/var/www/birthday-invitation/dist/*'
          else
            mkdir -p '/var/www/birthday-invitation/dist'
          fi
        "
    
    - name: Deploy files
      run: |
        echo "üì§ Deploying files..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
        if [ ! -d "dist" ]; then
          echo "‚ùå dist directory not found!"
          ls -la
          exit 1
        fi
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        scp -r dist/* deploy-server:'/var/www/birthday-invitation/dist/'
        
        echo "‚úÖ Files deployed"
        
        ssh deploy-server "
          echo 'Files on server:'
          ls -la '/var/www/birthday-invitation/dist/' | head -10
        "
    
    - name: Set permissions
      run: |
        echo "üîí Setting permissions..."
        ssh deploy-server "
          sudo chown -R www-data:www-data '/var/www/birthday-invitation/dist'
          sudo find '/var/www/birthday-invitation/dist' -type f -exec chmod 644 {} \;
          sudo find '/var/www/birthday-invitation/dist' -type d -exec chmod 755 {} \;
          echo '‚úÖ Permissions set'
        "
    
    - name: Configure Nginx
      run: |
        echo "‚öôÔ∏è Configuring Nginx..."
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π nginx –∫–æ–Ω—Ñ–∏–≥
        echo "server {
          listen 80;
          server_name ${{ secrets.DOMAIN }} www.${{ secrets.DOMAIN }};
          return 301 https://\$server_name\$request_uri;
        }
        
        server {
          listen 443 ssl http2;
          listen [::]:443 ssl http2;
          server_name ${{ secrets.DOMAIN }} www.${{ secrets.DOMAIN }};
          
          ssl_certificate /etc/ssl/certs/birthday-invitation.crt;
          ssl_certificate_key /etc/ssl/private/birthday-invitation.key;
          
          root /var/www/birthday-invitation/dist;
          index index.html;
          
          location / {
            try_files \$uri \$uri/ /index.html;
          }
          
          location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)\$ {
            expires 1y;
            add_header Cache-Control \"public, immutable\";
          }
        }" > nginx.conf
        
        # –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp nginx.conf deploy-server:/tmp/nginx.conf
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º
        ssh deploy-server "
          if ! command -v nginx &> /dev/null; then
            echo 'Installing nginx...'
            sudo apt update
            sudo apt install -y nginx
          fi
          
          sudo cp /tmp/nginx.conf /etc/nginx/sites-available/birthday-invitation
          sudo ln -sf /etc/nginx/sites-available/birthday-invitation /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
          
          sudo nginx -t && sudo systemctl reload nginx
          echo '‚úÖ Nginx configured'
        "
        
        rm nginx.conf
    
    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        sleep 3
        
        ssh deploy-server "
          echo '=== Deployment Status ==='
          echo '1. Nginx status:'
          sudo systemctl status nginx --no-pager | head -3
          echo ''
          echo '2. Application files:'
          ls -la '/var/www/birthday-invitation/dist/index.html'
          echo ''
          echo '3. Health check:'
          if command -v curl > /dev/null; then
            curl -s -o /dev/null -w 'HTTP Status: %{http_code}\\n' https://localhost/
          else
            echo 'curl not installed'
          fi
        "
        
        echo ""
        echo "üéâ DEPLOYMENT SUCCESSFUL!"
        echo "üåê Your application is live at:"
        echo "   https://${{ secrets.DOMAIN }}"
        echo "   http://${{ secrets.SERVER_IP }}"

  notify:
    name: üì® Notify
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: Send Telegram notification
      env:
        BUILD_STATUS: ${{ needs.build.result }}
        DEPLOY_STATUS: ${{ needs.deploy.result }}
      run: |
        echo "üì® Sending notification..."
        
        if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
          STATUS="‚úÖ –£–°–ü–ï–®–ù–û"
          EMOJI="üéâ"
        else
          STATUS="‚ùå –û–®–ò–ë–ö–ê"
          EMOJI="‚ö†Ô∏è"
        fi
        
        MESSAGE="$EMOJI <b>–î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</b>\n\n$STATUS\n\nüåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: https://${{ secrets.DOMAIN }}\nüïê –í—Ä–µ–º—è: $(date '+%d.%m.%Y %H:%M')"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"HTML\"}" || echo "‚ö†Ô∏è Failed to send notification"
        
        echo "‚úÖ Notification sent"