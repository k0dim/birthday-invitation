name: ğŸš€ Production Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force:
        description: 'Force deployment (skip tests)'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== VALIDATION ====================
  validate:
    name: ğŸ” Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

  # ==================== BUILD ====================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 15
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      build_id: ${{ steps.generate_build_id.outputs.build_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Extract version
      id: extract_version
      run: |
        VERSION=$(node -p "require('./package.json').version || '1.0.0'")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version: $VERSION"
    
    - name: Generate build ID
      id: generate_build_id
      run: |
        BUILD_ID="${GITHUB_SHA:0:7}-$(date +%Y%m%d%H%M%S)"
        echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Build ID: $BUILD_ID"
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci
    
    - name: Build application
      env:
        VITE_TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        VITE_TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        VITE_APP_VERSION: ${{ steps.extract_version.outputs.version }}
        VITE_BUILD_ID: ${{ steps.generate_build_id.outputs.build_id }}
        VITE_BUILD_DATE: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        VITE_COMMIT_SHA: ${{ github.sha }}
      run: |
        echo "ğŸš€ Building application..."
        npm run build
        
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ dist/index.html not found!"
          exit 1
        fi
        
        echo "ğŸ“ Build contents:"
        ls -la dist/
    
    - name: Create build manifest
      run: |
        echo "ğŸ“„ Creating build manifest..."
        echo '{"application":"birthday-invitation","version":"'"${{ steps.extract_version.outputs.version }}"'","buildId":"'"${{ steps.generate_build_id.outputs.build_id }}"'","commitSha":"'"${{ github.sha }}"'","branch":"'"${{ github.ref_name }}"'","builtAt":"'"$(date -u +'%Y-%m-%dT%H:%M:%SZ')"'"}' > dist/build-manifest.json
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ steps.generate_build_id.outputs.build_id }}
        path: dist/
        retention-days: 30

  # ==================== DEPLOY ====================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ needs.build.outputs.build_id }}
    
    - name: Setup SSH
      run: |
        echo "ğŸ” Setting up SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        cat >> ~/.ssh/config << 'EOF'
        Host deploy-server
          HostName ${{ secrets.SERVER_IP }}
          User ${{ secrets.DEPLOY_USER }}
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config
    
    - name: Verify server connectivity
      run: |
        echo "ğŸ” Testing server connection..."
        ssh deploy-server "echo 'âœ… Connected!' && hostname"
    
    - name: Create backup
      run: |
        echo "ğŸ’¾ Creating backup..."
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        ssh deploy-server "
          sudo mkdir -p /var/backups/birthday-invitation
          if [ -d '/var/www/birthday-invitation/dist' ]; then
            echo 'Creating backup of existing deployment...'
            sudo tar -czf \"/var/backups/birthday-invitation/backup_$TIMESTAMP.tar.gz\" -C '/var/www/birthday-invitation' dist/
            echo 'âœ… Backup created: backup_$TIMESTAMP.tar.gz'
          else
            echo 'âš ï¸ No existing deployment found, skipping backup'
          fi
        "
    
    - name: Prepare directory on server
      run: |
        echo "ğŸ“ Preparing directory on server..."
        ssh deploy-server "
          sudo mkdir -p '/var/www/birthday-invitation'
          sudo chown -R '${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }}' '/var/www/birthday-invitation'
          
          if [ -d '/var/www/birthday-invitation/dist' ]; then
            echo 'Cleaning old deployment...'
            rm -rf '/var/www/birthday-invitation/dist/*'
          else
            mkdir -p '/var/www/birthday-invitation/dist'
          fi
          
          echo 'Directory prepared'
        "
    
    - name: Deploy files to server
      run: |
        echo "ğŸ“¤ Deploying files to server..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚
        if [ ! -d "dist" ]; then
          echo "âŒ dist directory not found!"
          ls -la
          exit 1
        fi
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑÑ Ğ¿Ğ°Ğ¿ĞºÑƒ dist
        scp -r dist deploy-server:'/var/www/birthday-invitation/'
        
        echo "âœ… Files copied to server"
        
        ssh deploy-server "
          echo 'Checking deployed files...'
          ls -la '/var/www/birthday-invitation/dist/' | head -5
        "
    
    - name: Set permissions on server
      run: |
        echo "ğŸ”’ Setting permissions on server..."
        ssh deploy-server "
          sudo chown -R www-data:www-data '/var/www/birthday-invitation/dist'
          sudo find '/var/www/birthday-invitation/dist' -type f -exec chmod 644 {} \;
          sudo find '/var/www/birthday-invitation/dist' -type d -exec chmod 755 {} \;
          echo 'âœ… Permissions set'
        "
    
    - name: Configure Nginx
      run: |
        echo "âš™ï¸ Configuring Nginx..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ
        cat > nginx-birthday.conf << 'NGINXEOF'
server {
    listen 80;
    server_name DOMAIN www.DOMAIN;
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name DOMAIN www.DOMAIN;
    
    ssl_certificate /etc/ssl/certs/birthday-invitation.crt;
    ssl_certificate_key /etc/ssl/private/birthday-invitation.key;
    
    root /var/www/birthday-invitation/dist;
    index index.html;
    
    location / {
        try_files \$uri \$uri/ /index.html;
    }
    
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /health {
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
NGINXEOF
        
        # Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ DOMAIN Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¾Ğ¼ĞµĞ½
        sed -i "s/DOMAIN/${{ secrets.DOMAIN }}/g" nginx-birthday.conf
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        scp nginx-birthday.conf deploy-server:/tmp/nginx-birthday.conf
        
        # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ nginx Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
        ssh deploy-server "
          echo 'Setting up Nginx...'
          
          if ! command -v nginx &> /dev/null; then
            echo 'Installing nginx...'
            sudo apt update
            sudo apt install -y nginx
          fi
          
          sudo cp /tmp/nginx-birthday.conf /etc/nginx/sites-available/birthday-invitation
          
          if [ ! -L '/etc/nginx/sites-enabled/birthday-invitation' ]; then
            sudo ln -s /etc/nginx/sites-available/birthday-invitation /etc/nginx/sites-enabled/
          fi
          
          sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
          
          echo 'Testing Nginx configuration...'
          sudo nginx -t
          
          if [ \$? -eq 0 ]; then
            echo 'âœ… Nginx configuration test passed'
            sudo systemctl reload nginx
            echo 'Nginx reloaded'
          else
            echo 'âŒ Nginx configuration test failed'
            exit 1
          fi
        "
        
        rm nginx-birthday.conf
    
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 5
        
        ssh deploy-server "
          echo '=== Server Status ==='
          echo '1. Nginx service:'
          sudo systemctl is-active nginx
          echo ''
          echo '2. Deployed files:'
          ls -la '/var/www/birthday-invitation/dist/' | grep -E 'index.html|total'
          echo ''
          echo '3. Local access test:'
          if command -v curl > /dev/null; then
            curl -s -o /dev/null -w '%{http_code}' https://localhost/ && echo ' - OK'
          else
            echo 'curl not available'
          fi
        "
        
        echo ""
        echo "=========================================="
        echo "ğŸ‰ DEPLOYMENT COMPLETED!"
        echo ""
        echo "ğŸŒ Your application is available at:"
        echo "   â€¢ https://${{ secrets.DOMAIN }}"
        echo "=========================================="

  # ==================== NOTIFICATION ====================
  notify:
    name: ğŸ“¨ Notify
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: Send Telegram notification
      env:
        BUILD_STATUS: ${{ needs.build.result }}
        DEPLOY_STATUS: ${{ needs.deploy.result }}
      run: |
        echo "ğŸ“¨ Sending Telegram notification..."
        
        if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
          EMOJI="ğŸ‰"
          STATUS="âœ… Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ"
        elif [ "$DEPLOY_STATUS" = "failure" ]; then
          EMOJI="âŒ"
          STATUS="âš ï¸ ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ”Ğ•ĞŸĞ›ĞĞ¯"
        elif [ "$BUILD_STATUS" = "failure" ]; then
          EMOJI="ğŸš¨"
          STATUS="âš ï¸ ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ¡Ğ‘ĞĞ ĞšĞ˜"
        else
          EMOJI="âšª"
          STATUS="â“ ĞĞ•Ğ˜Ğ—Ğ’Ğ•Ğ¡Ğ¢ĞĞ"
        fi
        
        MESSAGE="${EMOJI} <b>Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ birthday-invitation</b>\n\n${STATUS}\n\nğŸ“¦ Ğ’ĞµÑ€ÑĞ¸Ñ: ${{ needs.build.outputs.version }}\nğŸ·ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°: ${{ needs.build.outputs.build_id }}\n\nğŸŒ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ:\nhttps://${{ secrets.DOMAIN }}\n\nğŸ• $(date '+%d.%m.%Y %H:%M:%S')"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"HTML\"}" || echo "âš ï¸ Failed to send Telegram notification"
        
        echo "âœ… Notification sent"

  # ==================== CLEANUP ====================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    
    steps:
    - name: Deployment summary
      run: |
        echo "ğŸ“‹ ===== DEPLOYMENT SUMMARY ====="
        echo ""
        echo "ğŸ—ï¸ Application: birthday-invitation"
        echo "ğŸš€ Trigger: ${{ github.event_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo ""
        echo "ğŸ“Š Pipeline Results:"
        echo "  âœ… Validate: ${{ needs.validate.result }}"
        echo "  âœ… Build: ${{ needs.build.result }}"
        echo "  âœ… Deploy: ${{ needs.deploy.result }}"
        echo "  âœ… Notify: ${{ needs.notify.result }}"
        echo ""
        echo "ğŸŒ Application URL: https://${{ secrets.DOMAIN }}"
        echo "ğŸ·ï¸ Build ID: ${{ needs.build.outputs.build_id }}"
        echo "ğŸ“¦ Version: ${{ needs.build.outputs.version }}"
        echo ""
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "ğŸ‰ Deployment successful! Your application is live!"
        else
          echo "âŒ Deployment failed. Check logs above for details."
        fi