name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  APP_NAME: birthday-invitation
  NODE_VERSION: '18'
  
jobs:
  test-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build for production
      run: |
        echo "Building with environment variables..."
        VITE_TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
        VITE_TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
        npm run build
        
        echo "Build completed!"
        ls -la dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          dist/
          package.json
        retention-days: 7

  deploy-production:
    needs: test-and-build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # –°–æ–∑–¥–∞–µ–º SSH –∫–æ–Ω—Ñ–∏–≥
        cat >> ~/.ssh/config << EOF
        Host deploy-server
          HostName ${{ secrets.SERVER_IP }}
          User ${{ secrets.DEPLOY_USER }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config
    
    - name: Test SSH connection
      run: |
        echo "Testing SSH connection to ${{ secrets.SERVER_IP }}..."
        ssh deploy-server "echo '‚úÖ SSH connection successful!'"
    
    - name: Create environment file on server
      run: |
        echo "Creating .env.production on server..."
        
        # –°–æ–∑–¥–∞–µ–º .env.production —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
        cat > .env.production << EOF
        NODE_ENV=production
        VITE_BASE_URL=/
        VITE_TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
        VITE_TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
        EOF
        
        # –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp .env.production deploy-server:/tmp/.env.production
        rm .env.production
    
    - name: Deploy to server
      run: |
        echo "üöÄ Starting deployment to production..."
        
        # 1. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh deploy-server "
          echo 'Creating directory structure...'
          sudo mkdir -p /var/www/${{ env.APP_NAME }}
          sudo chown -R ${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }} /var/www/${{ env.APP_NAME }}
          
          # 2. –ö–æ–ø–∏—Ä—É–µ–º .env.production –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ
          sudo mv /tmp/.env.production /var/www/${{ env.APP_NAME }}/.env.production
          sudo chmod 600 /var/www/${{ env.APP_NAME }}/.env.production
        "
        
        # 3. –ö–æ–ø–∏—Ä—É–µ–º build artifacts
        echo "Copying build files..."
        rsync -avz \
          --exclude node_modules \
          --exclude .git \
          --exclude .env.local \
          --exclude .env.development \
          ./ deploy-server:/var/www/${{ env.APP_NAME }}/
        
        # 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh deploy-server "
          cd /var/www/${{ env.APP_NAME }}
          
          echo 'Setting up nginx configuration...'
          sudo mkdir -p /etc/nginx/ssl
          
          # –ö–æ–ø–∏—Ä—É–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
          if [ -f infra/ssl/selfsigned.crt ]; then
            sudo cp infra/ssl/selfsigned.crt /etc/nginx/ssl/
            sudo cp infra/ssl/selfsigned.key /etc/nginx/ssl/
            sudo chmod 600 /etc/nginx/ssl/selfsigned.key
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º nginx –∫–æ–Ω—Ñ–∏–≥
          if [ -f infra/nginx/ssl.conf ]; then
            sudo cp infra/nginx/ssl.conf /etc/nginx/sites-available/${{ env.APP_NAME }}
            
            # –ó–∞–º–µ–Ω—è–µ–º –¥–æ–º–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥–µ
            sudo sed -i 's/your-domain.com/${{ secrets.DOMAIN }}/g' /etc/nginx/sites-available/${{ env.APP_NAME }}
            sudo sed -i 's/birthday.your-domain.com/${{ secrets.DOMAIN }}/g' /etc/nginx/sites-available/${{ env.APP_NAME }}
            
            sudo ln -sf /etc/nginx/sites-available/${{ env.APP_NAME }} /etc/nginx/sites-enabled/
          else
            echo '‚ö†Ô∏è  No nginx config found, using default'
          fi
          
          echo 'Testing nginx configuration...'
          sudo nginx -t || exit 1
          
          echo 'Reloading nginx...'
          sudo systemctl reload nginx
          
          echo 'Checking application...'
          ls -la dist/
          
          echo '‚úÖ Deployment completed successfully!'
        "
        
        echo "üåê Application should be available at: https://${{ secrets.DOMAIN }}"
    
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        
        # –î–∞–µ–º nginx –≤—Ä–µ–º—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
        sleep 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        curl -f -I https://${{ secrets.DOMAIN }} || echo "‚ö†Ô∏è  Application not responding yet, might need a moment..."
        
        ssh deploy-server "
          echo 'Server status:'
          echo '--- nginx status ---'
          sudo systemctl status nginx --no-pager | head -20
          echo '--- disk usage ---'
          df -h /var/www
          echo '--- app directory ---'
          ls -la /var/www/${{ env.APP_NAME }}/dist/ | head -10
        "

  notify:
    needs: [test-and-build, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Telegram notification
      run: |
        DEPLOY_STATUS="${{ needs.deploy-production.result || 'unknown' }}"
        COMMIT_MESSAGE=$(git log -1 --pretty=%B)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        
        if [ "$DEPLOY_STATUS" = "success" ]; then
          EMOJI="‚úÖ"
          STATUS_TEXT="—É—Å–ø–µ—à–Ω–æ"
        else
          EMOJI="‚ùå"
          STATUS_TEXT="—Å –æ—à–∏–±–∫–æ–π"
        fi
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"${EMOJI} <b>GitHub Actions Deploy</b>\n\n–°—Ç–∞—Ç—É—Å: ${STATUS_TEXT}\n–í–µ—Ç–∫–∞: ${{ github.ref_name }}\n–ö–æ–º–º–∏—Ç: ${COMMIT_MESSAGE}\n–ê–≤—Ç–æ—Ä: ${COMMIT_AUTHOR}\n\n–°—Å—ã–ª–∫–∞: https://${{ secrets.DOMAIN }}\",
            \"parse_mode\": \"HTML\",
            \"disable_web_page_preview\": true
          }"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}