name: ğŸš€ Production Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force:
        description: 'Force deployment (skip tests)'
        required: false
        default: false
        type: boolean

# ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ² Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Global environment variables
  APP_NAME: 'birthday-invitation'
  NODE_VERSION: '20'
  PNPM_VERSION: '8'
  
  # Deployment paths
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_PATH: '/var/www/${{ env.APP_NAME }}'
  BACKUP_PATH: '/var/backups/${{ env.APP_NAME }}'
  
  # Nginx
  NGINX_SITES_AVAILABLE: '/etc/nginx/sites-available'
  NGINX_SITES_ENABLED: '/etc/nginx/sites-enabled'
  NGINX_SITE_NAME: '${{ env.APP_NAME }}'

jobs:
  # ==================== VALIDATION ====================
  validate:
    name: ğŸ” Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Validate branch protection
      if: github.event_name == 'push'
      run: |
        echo "ğŸ”’ Validating branch: ${{ github.ref }}"
        if [[ "${{ github.ref }}" != "refs/heads/main" && "${{ github.ref }}" != "refs/heads/master" ]]; then
          echo "âš ï¸  Only main/master branches can be deployed to production"
          exit 1
        fi
    
    - name: Validate secrets
      run: |
        echo "ğŸ” Validating required secrets..."
        required_secrets=(
          "TELEGRAM_BOT_TOKEN"
          "TELEGRAM_CHAT_ID"
          "SERVER_IP"
          "DEPLOY_USER"
          "SSH_PRIVATE_KEY"
          "DOMAIN"
        )
        
        for secret in "${required_secrets[@]}"; do
          if [ -z "${secret}" ]; then
            echo "âŒ Missing secret: $secret"
            exit 1
          else
            echo "âœ… $secret: Configured"
          fi
        done
        
        echo "âœ… All secrets validated"
    
    - name: Validate package.json
      run: |
        echo "ğŸ“¦ Validating package.json..."
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found"
          exit 1
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
        jq -e '.name' package.json > /dev/null || (echo "âŒ Missing name in package.json" && exit 1)
        jq -e '.version' package.json > /dev/null || (echo "âŒ Missing version in package.json" && exit 1)
        jq -e '.scripts.build' package.json > /dev/null || (echo "âŒ Missing build script in package.json" && exit 1)
        
        echo "âœ… package.json is valid"
    
    - name: Code quality check
      run: |
        echo "ğŸ“ Checking code quality..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
        required_files=(
          "src/App.jsx"
          "src/main.jsx"
          "src/index.css"
          "index.html"
          "vite.config.js"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âš ï¸  Missing recommended file: $file"
          fi
        done
        
        # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
        find src -name "*.jsx" -o -name "*.js" | while read file; do
          if [ ! -s "$file" ]; then
            echo "âš ï¸  Empty file: $file"
          fi
        done
        
        echo "âœ… Code quality check passed"

  # ==================== SECURITY SCAN ====================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Dependency audit
      run: |
        echo "ğŸ›¡ï¸  Running dependency audit..."
        npm audit --audit-level=moderate || echo "âš ï¸  Audit found vulnerabilities"
    
    - name: Check for exposed secrets
      run: |
        echo "ğŸ” Checking for exposed secrets..."
        # ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğµ ÑĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ² ĞºĞ¾Ğ´Ğµ
        forbidden_patterns=(
          "password.*="
          "token.*="
          "secret.*="
          "api[_-]key"
          "ssh[_-]key"
          "private[_-]key"
        )
        
        for pattern in "${forbidden_patterns[@]}"; do
          echo "Checking pattern: $pattern"
          if grep -r -i "$pattern" --include="*.js" --include="*.jsx" --include="*.json" --include="*.env*" . | grep -v "node_modules" | grep -v ".git"; then
            echo "âš ï¸  Potential secret found with pattern: $pattern"
          fi
        done
        
        echo "âœ… Secret scan completed"
    
    - name: Check environment files
      run: |
        echo "ğŸ“ Checking environment files..."
        # Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ Ñ‡Ñ‚Ğ¾ .env.local Ğ½Ğµ Ğ·Ğ°ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‡ĞµĞ½
        if [ -f ".env.local" ]; then
          echo "âŒ .env.local should not be committed to repository!"
          exit 1
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ .env.example
        if [ ! -f ".env.example" ]; then
          echo "âŒ .env.example is missing!"
          exit 1
        fi
        
        echo "âœ… Environment files check passed"

  # ==================== BUILD ====================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [validate, security]
    timeout-minutes: 15
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      build_id: ${{ steps.generate_build_id.outputs.build_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Setup pnpm (optional)
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
    
    - name: Extract version
      id: extract_version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version: $VERSION"
    
    - name: Generate build ID
      id: generate_build_id
      run: |
        BUILD_ID="${GITHUB_SHA:0:7}-$(date +%Y%m%d%H%M%S)"
        echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Build ID: $BUILD_ID"
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci --prefer-offline --no-audit
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
        echo "Dependencies installed:"
        npm list --depth=0
    
    - name: Build application
      env:
        VITE_TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        VITE_TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        VITE_APP_VERSION: ${{ steps.extract_version.outputs.version }}
        VITE_BUILD_ID: ${{ steps.generate_build_id.outputs.build_id }}
        VITE_BUILD_DATE: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        VITE_COMMIT_SHA: ${{ github.sha }}
        VITE_ENVIRONMENT: production
      run: |
        echo "ğŸš€ Building application with environment variables..."
        echo "Version: $VITE_APP_VERSION"
        echo "Build ID: $VITE_BUILD_ID"
        echo "Commit: $VITE_COMMIT_SHA"
        
        # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°
        npm run build
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸
        echo "ğŸ“ Build output:"
        ls -la dist/
        du -sh dist/
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ index.html
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ dist/index.html not found!"
          exit 1
        fi
    
    - name: Run tests
      if: ${{ !inputs.force || github.event.inputs.force != 'true' }}
      run: |
        echo "ğŸ§ª Running tests..."
        # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹
        if [ -f "package.json" ] && jq -e '.scripts.test' package.json > /dev/null; then
          npm test
        else
          echo "âš ï¸  No tests configured, skipping..."
        fi
    
    - name: Create build manifest
      run: |
        echo "ğŸ“„ Creating build manifest..."
        
        cat > dist/build-manifest.json << EOF
        {
          "application": "${{ env.APP_NAME }}",
          "version": "${{ steps.extract_version.outputs.version }}",
          "buildId": "${{ steps.generate_build_id.outputs.build_id }}",
          "commitSha": "${{ github.sha }}",
          "commitMessage": "${{ github.event.head_commit.message }}",
          "branch": "${{ github.ref_name }}",
          "builtAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "builtBy": "${{ github.actor }}",
          "environment": "production"
        }
        EOF
        
        echo "âœ… Build manifest created"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ steps.generate_build_id.outputs.build_id }}
        path: |
          dist/
          package.json
          package-lock.json
        retention-days: 30
        if-no-files-found: error

  # ==================== DEPLOY ====================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    environment: 
      name: production
      url: https://${{ secrets.DOMAIN }}
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ needs.build.outputs.build_id }}
    
    - name: Setup SSH with advanced configuration
      run: |
        echo "ğŸ” Setting up SSH connection..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸ ĞºĞ»ÑÑ‡
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ĞºĞ»ÑÑ‡Ğ°
        echo "ğŸ” Validating SSH key..."
        head -1 ~/.ssh/deploy_key
        tail -1 ~/.ssh/deploy_key
        
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ°
        chmod 600 ~/.ssh/deploy_key
        
        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
        ssh-keygen -y -f ~/.ssh/deploy_key > ~/.ssh/deploy_key.pub
        echo "Public key fingerprint:"
        ssh-keygen -l -f ~/.ssh/deploy_key
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
        cat >> ~/.ssh/config << EOF
        Host deploy-server
          HostName ${{ secrets.SERVER_IP }}
          User ${{ env.DEPLOY_USER }}
          IdentityFile ~/.ssh/deploy_key
          Port 22
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
          ConnectTimeout 30
          ServerAliveInterval 60
          ServerAliveCountMax 3
          LogLevel ERROR
        EOF
        
        chmod 600 ~/.ssh/config
        
        echo "âœ… SSH setup completed"
    
    - name: Verify server connectivity
      run: |
        echo "ğŸ” Testing server connectivity..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ
        ssh deploy-server "echo 'âœ… SSH connection successful!'"
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        ssh deploy-server "
          echo '=== Server Information ==='
          echo 'Hostname: \$(hostname)'
          echo 'Uptime: \$(uptime -p)'
          echo 'OS: \$(lsb_release -d | cut -f2)'
          echo 'Kernel: \$(uname -r)'
          echo ''
          echo '=== Disk Space ==='
          df -h /var /home
          echo ''
          echo '=== Memory ==='
          free -h
          echo ''
          echo '=== Nginx Status ==='
          if command -v nginx &> /dev/null; then
            nginx -v
            sudo systemctl is-active nginx
          else
            echo 'âŒ Nginx not installed'
          fi
        "
    
    - name: Create backup before deployment
      run: |
        echo "ğŸ’¾ Creating backup..."
        
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        BACKUP_NAME="${{ env.APP_NAME }}_backup_$TIMESTAMP.tar.gz"
        
        ssh deploy-server "
          echo 'Creating backup of current deployment...'
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ² ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
          sudo mkdir -p ${{ env.BACKUP_PATH }}
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±ÑĞºĞ°Ğ¿ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          if [ -d \"${{ env.DEPLOY_PATH }}/dist\" ]; then
            sudo tar -czf \"${{ env.BACKUP_PATH }}/$BACKUP_NAME\" -C \"${{ env.DEPLOY_PATH }}\" dist/
            echo \"âœ… Backup created: $BACKUP_NAME\"
            echo \"Backup size: \$(du -h ${{ env.BACKUP_PATH }}/$BACKUP_NAME | cut -f1)\"
            
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5 Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²
            echo 'Cleaning old backups (keeping last 5)...'
            sudo ls -t ${{ env.BACKUP_PATH }}/${{ env.APP_NAME }}_backup_*.tar.gz 2>/dev/null | tail -n +6 | sudo xargs -r rm
            echo 'Current backups:'
            sudo ls -lh ${{ env.BACKUP_PATH }}/${{ env.APP_NAME }}_backup_*.tar.gz 2>/dev/null || echo 'No previous backups'
          else
            echo 'âš ï¸  No existing deployment found, skipping backup'
          fi
        "
    
    - name: Prepare deployment directory
      run: |
        echo "ğŸ“ Preparing deployment directory..."
        
        ssh deploy-server "
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo chown -R ${{ env.DEPLOY_USER }}:${{ env.DEPLOY_USER }} ${{ env.DEPLOY_PATH }}
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
          mkdir -p ${{ env.DEPLOY_PATH }}/dist
          mkdir -p ${{ env.DEPLOY_PATH }}/logs
          mkdir -p ${{ env.DEPLOY_PATH }}/config
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¸Ğ¼Ğ»Ğ¸Ğ½Ğº Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          ln -sfn ${{ env.DEPLOY_PATH }}/dist ${{ env.DEPLOY_PATH }}/current
          
          echo 'Directory structure:'
          ls -la ${{ env.DEPLOY_PATH }}/
        "
    
    - name: Deploy application files
      run: |
        echo "ğŸ“¤ Deploying application files..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
        DEPLOY_TEMP_DIR="/tmp/deploy_${{ needs.build.outputs.build_id }}"
        mkdir -p $DEPLOY_TEMP_DIR
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸
        cp -r dist/* $DEPLOY_TEMP_DIR/
        cp build-manifest.json $DEPLOY_TEMP_DIR/
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ğ²ĞµÑ€ÑĞ¸Ğ¸
        echo "${{ needs.build.outputs.build_id }}" > $DEPLOY_TEMP_DIR/.version
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        echo "Copying files to server..."
        scp -r $DEPLOY_TEMP_DIR/* deploy-server:${{ env.DEPLOY_PATH }}/dist/
        
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ°
        ssh deploy-server "
          echo 'Setting file permissions...'
          sudo chown -R www-data:www-data ${{ env.DEPLOY_PATH }}/dist
          sudo find ${{ env.DEPLOY_PATH }}/dist -type f -exec chmod 644 {} \;
          sudo find ${{ env.DEPLOY_PATH }}/dist -type d -exec chmod 755 {} \;
          
          echo 'Deployed files:'
          ls -la ${{ env.DEPLOY_PATH }}/dist/ | head -15
          echo ''
          echo 'Total size:'
          du -sh ${{ env.DEPLOY_PATH }}/dist/
        "
        
        # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
        rm -rf $DEPLOY_TEMP_DIR
        
        echo "âœ… Files deployed successfully"
    
    - name: Configure Nginx
      run: |
        echo "âš™ï¸  Configuring Nginx..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
        cat > nginx-site.conf << EOF
        # Birthday Invitation Application
        # Generated: $(date)
        # Build: ${{ needs.build.outputs.build_id }}
        
        server {
            listen 80;
            server_name ${{ secrets.DOMAIN }} www.${{ secrets.DOMAIN }};
            return 301 https://\$server_name\$request_uri;
        }
        
        server {
            listen 443 ssl http2;
            listen [::]:443 ssl http2;
            server_name ${{ secrets.DOMAIN }} www.${{ secrets.DOMAIN }};
            
            # SSL Configuration
            ssl_certificate /etc/ssl/certs/${{ env.APP_NAME }}.crt;
            ssl_certificate_key /etc/ssl/private/${{ env.APP_NAME }}.key;
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305';
            ssl_prefer_server_ciphers off;
            ssl_session_cache shared:SSL:10m;
            ssl_session_timeout 10m;
            
            # Security Headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
            
            # Root directory
            root ${{ env.DEPLOY_PATH }}/dist;
            index index.html;
            
            # Logging
            access_log ${{ env.DEPLOY_PATH }}/logs/nginx-access.log;
            error_log ${{ env.DEPLOY_PATH }}/logs/nginx-error.log;
            
            # Gzip Compression
            gzip on;
            gzip_vary on;
            gzip_min_length 1024;
            gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
            
            # SPA routing
            location / {
                try_files \$uri \$uri/ /index.html;
                expires -1;
            }
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
                access_log off;
            }
            
            # Health check endpoint
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
            
            # Version endpoint
            location /version {
                alias ${{ env.DEPLOY_PATH }}/dist/.version;
                access_log off;
                add_header Content-Type text/plain;
            }
            
            # Block access to sensitive files
            location ~ /\. {
                deny all;
                access_log off;
                log_not_found off;
            }
            
            location ~* \.(log|sql|db|bak|old|orig)$ {
                deny all;
                access_log off;
                log_not_found off;
            }
            
            # Custom error pages
            error_page 404 /index.html;
            error_page 500 502 503 504 /50x.html;
            location = /50x.html {
                root /usr/share/nginx/html;
            }
        }
        EOF
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        scp nginx-site.conf deploy-server:/tmp/nginx-${{ env.NGINX_SITE_NAME }}.conf
        
        # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ nginx
        ssh deploy-server "
          echo 'Applying Nginx configuration...'
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
          sudo cp /tmp/nginx-${{ env.NGINX_SITE_NAME }}.conf ${{ env.NGINX_SITES_AVAILABLE }}/${{ env.NGINX_SITE_NAME }}
          
          # ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ°Ğ¹Ñ‚
          sudo ln -sf ${{ env.NGINX_SITES_AVAILABLE }}/${{ env.NGINX_SITE_NAME }} ${{ env.NGINX_SITES_ENABLED }}/
          
          # Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
          echo 'Testing Nginx configuration...'
          sudo nginx -t
          
          if [ \$? -eq 0 ]; then
            echo 'âœ… Nginx configuration test passed'
            
            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ nginx
            echo 'Reloading Nginx...'
            sudo systemctl reload nginx
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            echo 'Nginx status:'
            sudo systemctl status nginx --no-pager | head -10
          else
            echo 'âŒ Nginx configuration test failed'
            exit 1
          fi
        "
        
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
        rm nginx-site.conf
    
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # Ğ–Ğ´ĞµĞ¼ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ nginx Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ğ»ÑÑ
        sleep 5
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
        echo "Testing application availability..."
        
        ssh deploy-server "
          echo '=== Local curl test ==='
          curl -s -o /dev/null -w '%{http_code}' https://localhost/health
          echo ' - Health check'
          
          curl -s -o /dev/null -w '%{http_code}' https://localhost/
          echo ' - Home page'
          
          curl -s https://localhost/version
          echo ' - Version'
          
          echo ''
          echo '=== Deployment verification ==='
          echo 'Build ID deployed:'
          cat ${{ env.DEPLOY_PATH }}/dist/.version 2>/dev/null || echo 'Not found'
          
          echo ''
          echo '=== Nginx verification ==='
          sudo nginx -t 2>&1
          echo ''
          sudo systemctl status nginx --no-pager | grep -E '(Active|Main PID|Status)'
          
          echo ''
          echo '=== Disk usage ==='
          df -h ${{ env.DEPLOY_PATH }}
        "
        
        # Ğ’Ğ½ĞµÑˆĞ½ÑÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
        echo "=== External verification ==="
        echo "Application should be available at:"
        echo "  â€¢ https://${{ secrets.DOMAIN }}"
        echo "  â€¢ http://${{ secrets.SERVER_IP }} (HTTP redirect to HTTPS)"
        echo ""
        echo "âœ… Deployment verification completed"

  # ==================== POST-DEPLOYMENT ====================
  post_deploy:
    name: ğŸ“Š Post-Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    timeout-minutes: 10
    
    steps:
    - name: Checkout for git info
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate deployment report
      run: |
        echo "ğŸ“Š Generating deployment report..."
        
        # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
        DEPLOYMENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        GIT_COMMIT=$(git log -1 --pretty=format:"%H")
        GIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        GIT_MESSAGE=$(git log -1 --pretty=format:"%s")
        BRANCH="${GITHUB_REF#refs/heads/}"
        
        cat > deployment-report.md << EOF
        # Deployment Report
        
        ## Summary
        - **Application**: ${{ env.APP_NAME }}
        - **Environment**: Production
        - **Status**: ${{ needs.deploy.result }}
        - **Deployed At**: $DEPLOYMENT_TIME
        
        ## Build Information
        - **Build ID**: ${{ needs.build.outputs.build_id }}
        - **Version**: ${{ needs.build.outputs.version }}
        - **Commit**: $GIT_COMMIT
        - **Author**: $GIT_AUTHOR
        - **Message**: $GIT_MESSAGE
        - **Branch**: $BRANCH
        
        ## Deployment Details
        - **Server**: ${{ secrets.SERVER_IP }}
        - **Domain**: ${{ secrets.DOMAIN }}
        - **Deploy Path**: ${{ env.DEPLOY_PATH }}
        - **Backup Created**: Yes
        
        ## Quality Gates
        - **Validation**: ${{ needs.validate.result }}
        - **Security Scan**: ${{ needs.security.result }}
        - **Build**: ${{ needs.build.result }}
        - **Deploy**: ${{ needs.deploy.result }}
        
        ## Links
        - **Application**: https://${{ secrets.DOMAIN }}
        - **Repository**: ${{ github.server_url }}/${{ github.repository }}
        - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        
        ## Next Steps
        1. Monitor application logs
        2. Test critical functionality
        3. Update monitoring dashboards
        EOF
        
        echo "âœ… Deployment report generated"
        cat deployment-report.md
    
    - name: Send deployment notification
      env:
        BUILD_STATUS: ${{ needs.build.result }}
        DEPLOY_STATUS: ${{ needs.deploy.result }}
        COMMIT_SHA: ${GITHUB_SHA:0:7}
        COMMIT_MESSAGE: $(git log -1 --pretty=%B | head -n1)
        COMMIT_AUTHOR: $(git log -1 --pretty=%an)
        BRANCH: ${GITHUB_REF#refs/heads/}
      run: |
        echo "ğŸ“¨ Sending deployment notification..."
        
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸
        if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
          EMOJI="ğŸ‰"
          STATUS_TEXT="<b>Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ</b> âœ…"
          STATUS_ICON="ğŸŸ¢"
        elif [ "$DEPLOY_STATUS" = "failure" ]; then
          EMOJI="âŒ"
          STATUS_TEXT="<b>ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ”Ğ•ĞŸĞ›ĞĞ¯</b> ğŸ”´"
          STATUS_ICON="ğŸ”´"
        elif [ "$BUILD_STATUS" = "failure" ]; then
          EMOJI="ğŸš¨"
          STATUS_TEXT="<b>ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ¡Ğ‘ĞĞ ĞšĞ˜</b> ğŸŸ "
          STATUS_ICON="ğŸŸ "
        else
          EMOJI="âš ï¸"
          STATUS_TEXT="<b>ĞĞ•Ğ˜Ğ—Ğ’Ğ•Ğ¡Ğ¢ĞĞ</b> âšª"
          STATUS_ICON="âšª"
        fi
        
        # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
        cat > message.txt << 'EOF'
        $EMOJI <b>Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ ${{ env.APP_NAME }}</b>
        
        $STATUS_ICON Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: $STATUS_TEXT
        ğŸ“¦ Ğ’ĞµÑ€ÑĞ¸Ñ: <code>${{ needs.build.outputs.version }}</code>
        ğŸ·ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°: <code>${{ needs.build.outputs.build_id }}</code>
        
        ğŸ“ <b>Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğµ:</b>
        â””â”€ Ğ’ĞµÑ‚ĞºĞ°: <code>$BRANCH</code>
        â””â”€ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: <code>$COMMIT_SHA</code>
        â””â”€ ĞĞ²Ñ‚Ğ¾Ñ€: $COMMIT_AUTHOR
        â””â”€ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: $COMMIT_MESSAGE
        
        ğŸŒ <b>Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:</b>
        â€¢ https://${{ secrets.DOMAIN }}
        â€¢ http://${{ secrets.SERVER_IP }}
        
        ğŸ”§ <b>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ:</b>
        â€¢ https://${{ secrets.DOMAIN }}/health
        â€¢ https://${{ secrets.DOMAIN }}/version
        
        ğŸ“Š <b>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÑ‹:</b>
        â€¢ Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ: ${{ needs.validate.result }}
        â€¢ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ: ${{ needs.security.result }}
        â€¢ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°: ${{ needs.build.result }}
        â€¢ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹: ${{ needs.deploy.result }}
        
        ğŸ• <i>$(date '+%d.%m.%Y %H:%M:%S')</i>
        EOF
        
        # ĞŸĞ¾Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
        MESSAGE=$(envsubst < message.txt)
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Telegram
        echo "Sending to Telegram..."
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$(echo "$MESSAGE" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\\n/\\\\n/g')\",
            \"parse_mode\": \"HTML\",
            \"disable_web_page_preview\": true,
            \"reply_markup\": {
              \"inline_keyboard\": [
                [
                  {\"text\": \"ğŸŒ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ\", \"url\": \"https://${{ secrets.DOMAIN }}\"},
                  {\"text\": \"ğŸ“Š ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸\", \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}
                ]
              ]
            }
          }"
        
        echo "âœ… Notification sent to Telegram"
        rm -f message.txt
  # ==================== CLEANUP ====================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [post_deploy]
    if: always()
    
    steps:
    - name: Cleanup old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ (Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5)
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          const buildArtifacts = artifacts.data.artifacts
            .filter(artifact => artifact.name.startsWith('build-'))
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          
          // ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5 Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²
          const artifactsToDelete = buildArtifacts.slice(5);
          
          for (const artifact of artifactsToDelete) {
            console.log(`Deleting old artifact: ${artifact.name}`);
            await github.rest.actions.deleteArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id
            });
          }
    
    - name: Summary
      if: always()
      run: |
        echo "ğŸ“‹ ===== DEPLOYMENT PIPELINE SUMMARY ====="
        echo ""
        echo "ğŸ—ï¸  Application: ${{ env.APP_NAME }}"
        echo "ğŸš€ Trigger: ${{ github.event_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸŒ¿ Branch: ${GITHUB_REF#refs/heads/}"
        echo ""
        echo "ğŸ“Š Job Results:"
        echo "  ğŸ” Validate: ${{ needs.validate.result }}"
        echo "  ğŸ”’ Security: ${{ needs.security.result }}"
        echo "  ğŸ—ï¸  Build: ${{ needs.build.result }}"
        echo "  ğŸš€ Deploy: ${{ needs.deploy.result }}"
        echo "  ğŸ“Š Post-Deploy: ${{ needs.post_deploy.result }}"
        echo ""
        echo "ğŸŒ Application URL: https://${{ secrets.DOMAIN }}"
        echo "ğŸ“ Build ID: ${{ needs.build.outputs.build_id }}"
        echo ""
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Deployment pipeline completed successfully!"
          echo "ğŸ‰ Your application is now live!"
        else
          echo "âŒ Deployment pipeline failed!"
          echo "ğŸ” Check the logs above for details."
        fi