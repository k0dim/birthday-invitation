name: ğŸš€ Production Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force:
        description: 'Force deployment (skip tests)'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ env Ğ±Ğ»Ğ¾Ğº Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑÑÑ‹Ğ»Ğ°ÑÑ‚ÑÑ Ğ´Ñ€ÑƒĞ³ Ğ½Ğ° Ğ´Ñ€ÑƒĞ³Ğ°
# Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ…Ğ°Ñ€Ğ´ĞºĞ¾Ğ´Ğ¸Ğ½Ğ³ Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ² steps

jobs:
  # ==================== VALIDATION ====================
  validate:
    name: ğŸ” Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

  # ==================== SECURITY SCAN ====================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Dependency audit
      run: |
        echo "ğŸ›¡ï¸ Running dependency audit..."
        npm audit --audit-level=moderate || echo "âš ï¸ Audit found vulnerabilities"

  # ==================== BUILD ====================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [validate, security]
    timeout-minutes: 15
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      build_id: ${{ steps.generate_build_id.outputs.build_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Extract version
      id: extract_version
      run: |
        VERSION=$(node -p "require('./package.json').version || '1.0.0'")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version: $VERSION"
    
    - name: Generate build ID
      id: generate_build_id
      run: |
        BUILD_ID="${GITHUB_SHA:0:7}-$(date +%Y%m%d%H%M%S)"
        echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Build ID: $BUILD_ID"
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci
    
    - name: Build application
      env:
        VITE_TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        VITE_TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        VITE_APP_VERSION: ${{ steps.extract_version.outputs.version }}
        VITE_BUILD_ID: ${{ steps.generate_build_id.outputs.build_id }}
        VITE_BUILD_DATE: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        VITE_COMMIT_SHA: ${{ github.sha }}
      run: |
        echo "ğŸš€ Building application..."
        npm run build
        
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ dist/index.html not found!"
          exit 1
        fi
    
    - name: Create build manifest
      run: |
        echo "ğŸ“„ Creating build manifest..."
        echo '{"application":"birthday-invitation","version":"'"${{ steps.extract_version.outputs.version }}"'","buildId":"'"${{ steps.generate_build_id.outputs.build_id }}"'","commitSha":"'"${{ github.sha }}"'","branch":"'"${{ github.ref_name }}"'","builtAt":"'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"}' > dist/build-manifest.json
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ steps.generate_build_id.outputs.build_id }}
        path: dist/
        retention-days: 30

  # ==================== DEPLOY ====================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ needs.build.outputs.build_id }}
    
    - name: Setup SSH
      run: |
        echo "ğŸ” Setting up SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        cat >> ~/.ssh/config << 'EOF'
        Host deploy-server
          HostName ${{ secrets.SERVER_IP }}
          User ${{ secrets.DEPLOY_USER }}
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config
    
    - name: Verify server connectivity
      run: |
        echo "ğŸ” Testing server connection..."
        ssh deploy-server "echo 'âœ… Connected!'"
    
    - name: Define deployment variables
      id: vars
      run: |
        echo "APP_NAME=birthday-invitation" >> $GITHUB_OUTPUT
        echo "DEPLOY_PATH=/var/www/birthday-invitation" >> $GITHUB_OUTPUT
        echo "BACKUP_PATH=/var/backups/birthday-invitation" >> $GITHUB_OUTPUT
        echo "NGINX_SITE_NAME=birthday-invitation" >> $GITHUB_OUTPUT
    
    - name: Create backup
      run: |
        echo "ğŸ’¾ Creating backup..."
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        ssh deploy-server "
          sudo mkdir -p /var/backups/birthday-invitation
          if [ -d '/var/www/birthday-invitation/dist' ]; then
            sudo tar -czf '/var/backups/birthday-invitation/backup_$TIMESTAMP.tar.gz' -C '/var/www/birthday-invitation' dist/
            echo 'âœ… Backup created'
          else
            echo 'âš ï¸ No existing deployment'
          fi
        "
    
    - name: Prepare directory
      run: |
        echo "ğŸ“ Preparing directory..."
        ssh deploy-server "
          sudo mkdir -p '/var/www/birthday-invitation'
          sudo chown -R '${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }}' '/var/www/birthday-invitation'
          mkdir -p '/var/www/birthday-invitation/dist'
        "
    
    - name: Deploy files
      run: |
        echo "ğŸ“¤ Deploying files..."
        scp -r dist/* deploy-server:'/var/www/birthday-invitation/dist/'
        
        ssh deploy-server "
          sudo chown -R www-data:www-data '/var/www/birthday-invitation/dist'
          sudo find '/var/www/birthday-invitation/dist' -type f -exec chmod 644 {} \;
          sudo find '/var/www/birthday-invitation/dist' -type d -exec chmod 755 {} \;
          echo 'âœ… Files deployed'
        "
    
    - name: Configure Nginx
      run: |
        echo "âš™ï¸ Configuring Nginx..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
        NGINX_CONFIG="server {
            listen 80;
            server_name ${{ secrets.DOMAIN }} www.${{ secrets.DOMAIN }};
            return 301 https://\$server_name\$request_uri;
        }
        
        server {
            listen 443 ssl http2;
            listen [::]:443 ssl http2;
            server_name ${{ secrets.DOMAIN }} www.${{ secrets.DOMAIN }};
            
            ssl_certificate /etc/ssl/certs/birthday-invitation.crt;
            ssl_certificate_key /etc/ssl/private/birthday-invitation.key;
            
            root /var/www/birthday-invitation/dist;
            index index.html;
            
            location / {
                try_files \$uri \$uri/ /index.html;
            }
            
            location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control \"public, immutable\";
            }
        }"
        
        echo "$NGINX_CONFIG" > nginx.conf
        scp nginx.conf deploy-server:/tmp/nginx.conf
        
        ssh deploy-server "
          sudo cp /tmp/nginx.conf /etc/nginx/sites-available/birthday-invitation
          sudo ln -sf /etc/nginx/sites-available/birthday-invitation /etc/nginx/sites-enabled/
          sudo nginx -t && sudo systemctl reload nginx
          echo 'âœ… Nginx configured'
        "
        
        rm nginx.conf
    
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 3
        
        ssh deploy-server "
          echo '=== Deployment status ==='
          if command -v curl > /dev/null; then
            curl -s -o /dev/null -w '%{http_code}' https://localhost/ && echo ' - HTTP Status OK'
          fi
          sudo systemctl status nginx --no-pager | head -3
        "
        
        echo "ğŸŒ Application available at: https://${{ secrets.DOMAIN }}"

  # ==================== NOTIFICATION ====================
  notify:
    name: ğŸ“¨ Notify
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: Checkout for git info
      uses: actions/checkout@v4
    
    - name: Send Telegram notification
      env:
        BUILD_STATUS: ${{ needs.build.result }}
        DEPLOY_STATUS: ${{ needs.deploy.result }}
      run: |
        echo "ğŸ“¨ Sending notification..."
        
        COMMIT_SHA="${GITHUB_SHA:0:7}"
        COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1 | sed 's/"/\\"/g')
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        BRANCH="${GITHUB_REF#refs/heads/}"
        
        if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
          EMOJI="ğŸ‰"
          STATUS="âœ… Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ"
        else
          EMOJI="âŒ"
          STATUS="âš ï¸ ĞĞ¨Ğ˜Ğ‘ĞšĞ"
        fi
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        MESSAGE="${EMOJI} <b>Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½</b>\n\n${STATUS}\nğŸ“¦ Ğ’ĞµÑ€ÑĞ¸Ñ: ${{ needs.build.outputs.version }}\nğŸ·ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°: ${{ needs.build.outputs.build_id }}\n\nğŸ“ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:\nâ€¢ Ğ’ĞµÑ‚ĞºĞ°: ${BRANCH}\nâ€¢ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${COMMIT_SHA}\nâ€¢ ĞĞ²Ñ‚Ğ¾Ñ€: ${COMMIT_AUTHOR}\n\nğŸŒ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾:\nhttps://${{ secrets.DOMAIN }}\n\nğŸ• $(date '+%d.%m.%Y %H:%M')"
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Telegram
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"HTML\"}"
        
        echo "âœ… Notification sent"

  # ==================== CLEANUP ====================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "ğŸ“‹ ===== SUMMARY ====="
        echo ""
        echo "ğŸ—ï¸ Application: birthday-invitation"
        echo "ğŸ“Š Results:"
        echo "  ğŸ” Validate: ${{ needs.validate.result }}"
        echo "  ğŸ”’ Security: ${{ needs.security.result }}"
        echo "  ğŸ—ï¸ Build: ${{ needs.build.result }}"
        echo "  ğŸš€ Deploy: ${{ needs.deploy.result }}"
        echo ""
        echo "ğŸŒ URL: https://${{ secrets.DOMAIN }}"
        echo ""
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Pipeline completed successfully!"
        else
          echo "âŒ Pipeline failed!"
        fi