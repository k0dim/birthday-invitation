name: Simple Deploy

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build
        run: |
          npm ci
          VITE_TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
          VITE_TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
          npm run build
          
          # Проверяем что файлы созданы
          ls -la dist/
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          
          cat > ~/.ssh/config << EOF
          Host server
            HostName ${{ secrets.SERVER_IP }}
            User ${{ secrets.DEPLOY_USER }}
            IdentityFile ~/.ssh/key
            StrictHostKeyChecking no
          EOF
      
      - name: Deploy
        run: |
          # Создаем архив для удобства
          tar -czf deploy.tar.gz -C dist .
          
          # Копируем архив
          scp deploy.tar.gz server:/tmp/
          
          # Распаковываем на сервере
          ssh server "
            mkdir -p /var/www/birthday-invitation/dist
            tar -xzf /tmp/deploy.tar.gz -C /var/www/birthday-invitation/dist
            sudo systemctl reload nginx
          "
          
          # Очищаем
          rm deploy.tar.gz