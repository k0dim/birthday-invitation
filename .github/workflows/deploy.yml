name: ğŸš€ Production Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force:
        description: 'Force deployment (skip tests)'
        required: false
        default: false
        type: boolean

# ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ² Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Global environment variables
  APP_NAME: 'birthday-invitation'
  NODE_VERSION: '20'
  
  # Deployment paths
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_PATH: '/var/www/${{ env.APP_NAME }}'
  BACKUP_PATH: '/var/backups/${{ env.APP_NAME }}'
  
  # Nginx
  NGINX_SITES_AVAILABLE: '/etc/nginx/sites-available'
  NGINX_SITES_ENABLED: '/etc/nginx/sites-enabled'
  NGINX_SITE_NAME: '${{ env.APP_NAME }}'

jobs:
  # ==================== VALIDATION ====================
  validate:
    name: ğŸ” Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Validate branch protection
      if: github.event_name == 'push'
      run: |
        echo "ğŸ”’ Validating branch: ${{ github.ref }}"
        if [[ "${{ github.ref }}" != "refs/heads/main" && "${{ github.ref }}" != "refs/heads/master" ]]; then
          echo "âš ï¸  Only main/master branches can be deployed to production"
          exit 1
        fi
    
    - name: Validate secrets
      run: |
        echo "ğŸ” Validating required secrets..."
        # ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ÑĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹
        echo "âœ… Secrets validation passed (actual validation happens at runtime)"

  # ==================== SECURITY SCAN ====================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Dependency audit
      run: |
        echo "ğŸ›¡ï¸  Running dependency audit..."
        npm audit --audit-level=moderate || echo "âš ï¸  Audit found vulnerabilities (check logs)"
    
    - name: Check for exposed secrets
      run: |
        echo "ğŸ” Checking for exposed secrets..."
        # Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
        if grep -r "password\|token\|secret\|api_key\|private_key" --include="*.js" --include="*.jsx" --include="*.json" . 2>/dev/null | grep -v node_modules | grep -v .git; then
          echo "âš ï¸  Potential secrets found in code"
        else
          echo "âœ… No obvious secrets found in code"
        fi

  # ==================== BUILD ====================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [validate, security]
    timeout-minutes: 15
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      build_id: ${{ steps.generate_build_id.outputs.build_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Extract version
      id: extract_version
      run: |
        VERSION=$(node -p "require('./package.json').version || '1.0.0'")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version: $VERSION"
    
    - name: Generate build ID
      id: generate_build_id
      run: |
        BUILD_ID="${GITHUB_SHA:0:7}-$(date +%Y%m%d%H%M%S)"
        echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Build ID: $BUILD_ID"
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci --prefer-offline
    
    - name: Build application
      env:
        VITE_TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        VITE_TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        VITE_APP_VERSION: ${{ steps.extract_version.outputs.version }}
        VITE_BUILD_ID: ${{ steps.generate_build_id.outputs.build_id }}
        VITE_BUILD_DATE: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        VITE_COMMIT_SHA: ${{ github.sha }}
      run: |
        echo "ğŸš€ Building application..."
        echo "Version: $VITE_APP_VERSION"
        echo "Build ID: $VITE_BUILD_ID"
        
        npm run build
        
        echo "ğŸ“ Build output:"
        ls -la dist/
        
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ dist/index.html not found!"
          exit 1
        fi
    
    - name: Run tests
      if: ${{ !inputs.force || github.event.inputs.force != 'true' }}
      run: |
        echo "ğŸ§ª Running tests..."
        if grep -q '"test"' package.json; then
          npm test
        else
          echo "âš ï¸  No tests configured"
        fi
    
    - name: Create build manifest
      run: |
        echo "ğŸ“„ Creating build manifest..."
        cat > dist/build-manifest.json << EOF
        {
          "application": "${{ env.APP_NAME }}",
          "version": "${{ steps.extract_version.outputs.version }}",
          "buildId": "${{ steps.generate_build_id.outputs.build_id }}",
          "commitSha": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "builtAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        }
        EOF
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ steps.generate_build_id.outputs.build_id }}
        path: |
          dist/
          package.json
        retention-days: 30

  # ==================== DEPLOY ====================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    environment: 
      name: production
      url: https://${{ secrets.DOMAIN }}
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ needs.build.outputs.build_id }}
    
    - name: Setup SSH
      run: |
        echo "ğŸ” Setting up SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        cat >> ~/.ssh/config << EOF
        Host deploy-server
          HostName ${{ secrets.SERVER_IP }}
          User ${{ env.DEPLOY_USER }}
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
          ConnectTimeout 30
        EOF
        
        chmod 600 ~/.ssh/config
    
    - name: Verify server connectivity
      run: |
        echo "ğŸ” Testing server connection..."
        ssh deploy-server "echo 'âœ… Connected!' && hostname"
    
    - name: Create backup
      run: |
        echo "ğŸ’¾ Creating backup..."
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        ssh deploy-server "
          sudo mkdir -p ${{ env.BACKUP_PATH }}
          if [ -d \"${{ env.DEPLOY_PATH }}/dist\" ]; then
            sudo tar -czf \"${{ env.BACKUP_PATH }}/backup_\$TIMESTAMP.tar.gz\" -C \"${{ env.DEPLOY_PATH }}\" dist/
            echo \"âœ… Backup created\"
            sudo ls -t ${{ env.BACKUP_PATH }}/backup_*.tar.gz 2>/dev/null | tail -n +6 | sudo xargs -r rm
          else
            echo 'âš ï¸  No existing deployment'
          fi
        "
    
    - name: Prepare directory
      run: |
        echo "ğŸ“ Preparing directory..."
        ssh deploy-server "
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo chown -R ${{ env.DEPLOY_USER }}:${{ env.DEPLOY_USER }} ${{ env.DEPLOY_PATH }}
          mkdir -p ${{ env.DEPLOY_PATH }}/dist ${{ env.DEPLOY_PATH }}/logs
        "
    
    - name: Deploy files
      run: |
        echo "ğŸ“¤ Deploying files..."
        scp -r dist/* deploy-server:${{ env.DEPLOY_PATH }}/dist/
        
        ssh deploy-server "
          sudo chown -R www-data:www-data ${{ env.DEPLOY_PATH }}/dist
          sudo find ${{ env.DEPLOY_PATH }}/dist -type f -exec chmod 644 {} \;
          sudo find ${{ env.DEPLOY_PATH }}/dist -type d -exec chmod 755 {} \;
          echo 'âœ… Files deployed'
        "
    
    - name: Configure Nginx
      run: |
        echo "âš™ï¸  Configuring Nginx..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
        cat > nginx.conf << 'EOF'
        server {
            listen 80;
            server_name ${{ secrets.DOMAIN }} www.${{ secrets.DOMAIN }};
            return 301 https://$server_name$request_uri;
        }
        
        server {
            listen 443 ssl http2;
            listen [::]:443 ssl http2;
            server_name ${{ secrets.DOMAIN }} www.${{ secrets.DOMAIN }};
            
            ssl_certificate /etc/ssl/certs/${{ env.APP_NAME }}.crt;
            ssl_certificate_key /etc/ssl/private/${{ env.APP_NAME }}.key;
            
            root ${{ env.DEPLOY_PATH }}/dist;
            index index.html;
            
            location / {
                try_files $uri $uri/ /index.html;
            }
            
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
            
            location /health {
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
            
            location /version {
                alias ${{ env.DEPLOY_PATH }}/dist/.version;
                add_header Content-Type text/plain;
            }
        }
        EOF
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼
        scp nginx.conf deploy-server:/tmp/nginx.conf
        
        ssh deploy-server "
          sudo cp /tmp/nginx.conf ${{ env.NGINX_SITES_AVAILABLE }}/${{ env.NGINX_SITE_NAME }}
          sudo ln -sf ${{ env.NGINX_SITES_AVAILABLE }}/${{ env.NGINX_SITE_NAME }} ${{ env.NGINX_SITES_ENABLED }}/
          sudo nginx -t && sudo systemctl reload nginx
          echo 'âœ… Nginx configured'
        "
        
        rm nginx.conf
    
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying..."
        sleep 3
        
        ssh deploy-server "
          echo '=== Deployment status ==='
          curl -s -o /dev/null -w '%{http_code}' https://localhost/health && echo ' - Health OK'
          curl -s https://localhost/version && echo ' - Version'
          sudo systemctl status nginx --no-pager | head -3
        "
        
        echo "ğŸŒ Available at: https://${{ secrets.DOMAIN }}"

  # ==================== NOTIFICATION ====================
  notify:
    name: ğŸ“¨ Notify
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: Checkout for git info
      uses: actions/checkout@v4
    
    - name: Send Telegram notification
      env:
        BUILD_STATUS: ${{ needs.build.result }}
        DEPLOY_STATUS: ${{ needs.deploy.result }}
      run: |
        echo "ğŸ“¨ Sending notification..."
        
        COMMIT_SHA="${GITHUB_SHA:0:7}"
        COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        BRANCH="${GITHUB_REF#refs/heads/}"
        
        if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
          EMOJI="ğŸ‰"
          STATUS="âœ… Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ"
        else
          EMOJI="âŒ"
          STATUS="âš ï¸  ĞĞ¨Ğ˜Ğ‘ĞšĞ"
        fi
        
        MESSAGE="$EMOJI <b>Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½</b>

$STATUS
ğŸ“¦ Ğ’ĞµÑ€ÑĞ¸Ñ: ${{ needs.build.outputs.version }}
ğŸ·ï¸  Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°: ${{ needs.build.outputs.build_id }}

ğŸ“ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:
â€¢ Ğ’ĞµÑ‚ĞºĞ°: $BRANCH
â€¢ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: $COMMIT_SHA
â€¢ ĞĞ²Ñ‚Ğ¾Ñ€: $COMMIT_AUTHOR

ğŸŒ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾:
https://${{ secrets.DOMAIN }}

ğŸ• $(date '+%d.%m.%Y %H:%M')"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"${MESSAGE}\",
            \"parse_mode\": \"HTML\"
          }"
        
        echo "âœ… Notification sent"

  # ==================== CLEANUP ====================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "ğŸ“‹ ===== SUMMARY ====="
        echo ""
        echo "ğŸ—ï¸  Application: ${{ env.APP_NAME }}"
        echo "ğŸ“Š Results:"
        echo "  ğŸ” Validate: ${{ needs.validate.result }}"
        echo "  ğŸ”’ Security: ${{ needs.security.result }}"
        echo "  ğŸ—ï¸  Build: ${{ needs.build.result }}"
        echo "  ğŸš€ Deploy: ${{ needs.deploy.result }}"
        echo ""
        echo "ğŸŒ URL: https://${{ secrets.DOMAIN }}"
        echo ""
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Pipeline completed successfully!"
        else
          echo "âŒ Pipeline failed!"
        fi